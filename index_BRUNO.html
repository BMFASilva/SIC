<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pregnancy Tracker - Login</title>
</head>
<body>
    <div style="max-width: 400px; margin: 0 auto; padding: 20px;">
        <h1>Welcome to Pregnancy Tracker</h1>
        <p>Login to continue or create an account if you're new.</p>
        
        <!-- Formulário de login -->
        <form id="loginForm" method="POST">
            <label for="username">Username:</label><br>
            <input type="text" id="username" name="username" required><br><br>
            
            <label for="password">Password:</label><br>
            <input type="password" id="password" name="password" required><br><br>
            
            <button type="submit">Login</button>
        </form>
        
        <p>Don't have an account? <a href="#" id="createAccountLink">Create one here</a>.</p>

        <!-- Botão para mostrar informações -->
        <button id="showInfoBtn" disabled>Data de Gravidez</button>

        <!-- Seção escondida inicialmente -->
        <div id="extraInfo" style="display: none;">
            <label for="ultimaMenstruacao">Última Menstruação:</label>
            <input type="date" id="ultimaMenstruacao"><br><br>

            <label>Data Término Previsto:</label>
            <p id="dataTerminoPrevisto"></p>

            <button id="submitDataBtn">Submit</button>
        </div>

        <!-- Novo botão para Checkup da Semana -->
        <button id="showCheckupFormBtn">Checkup da Semana</button>

        <!-- Formulário de Checkup da Semana e Valores Médios juntos -->
        <div id="checkupBlock" style="display: none;">
            <!-- Formulário de Checkup da Semana -->
            <h3>Checkup da Semana</h3>
            <label for="semana">Semana:</label>
            <input type="number" id="semana" required><br><br>

            <label for="peso">Peso:</label>
            <input type="number" id="peso" required><br><br>

            <label for="comprimento">Comprimento:</label>
            <input type="number" id="comprimento" required><br><br>

            <button id="submitCheckupBtn">Ver Resultados</button>

            <!-- Título para Valores Médios -->
            <h3>Valores Médios</h3>

            <!-- Inputs de Valores Médios (não editáveis) -->
            <label for="semanaAvg">Semana:</label>
            <input type="number" id="semanaAvg" readonly><br><br>

            <label for="pesoAvg">Peso:</label>
            <input type="number" id="pesoAvg" readonly><br><br>

            <label for="comprimentoAvg">Comprimento:</label>
            <input type="number" id="comprimentoAvg" readonly><br><br>
            <h4>Facto</h3>
            <p id="randomFact"></p>
        </div>
        <!-- Botão para mostrar os resultados -->
    <button id="showResultsBtn">Mostrar Resultados</button>

    <!-- Container onde a tabela será exibida -->
    <div id="resultsTableContainer">
        <!-- Tabela para exibir os resultados -->
        <table id="resultsTable">
            <thead>
                <tr>
                    <th>Semana</th>
                    <th>Peso (Kg)</th>
                    <th>Comprimento (cm)</th>
                    <th>Peso Esperado (Kg)</th>
                    <th>Comprimento Esperado (cm)</th>
                    <th>Facto</th>
                </tr>
            </thead>
            <tbody>
                <!-- As linhas da tabela serão inseridas aqui dinamicamente -->
            </tbody>
        </table>
    </div>
    </div>

    <script type="module">
        // Função para logar e armazenar token e userID
        async function login(username, password) {
            const query = `
                mutation Login($username: String!, $password: String!) {
                    login(username: $username, password: $password) {
                        token
                        user {
                            id
                        }
                    }
                }
            `;
            const variables = { username, password };
            
            const response = await fetch('http://localhost:4000/graphql', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ query, variables })
            });

            const result = await response.json();
            if (result.data && result.data.login) {
                localStorage.setItem('authToken', result.data.login.token);
                localStorage.setItem('userID', result.data.login.user.id);  // Salva o userID no localStorage
                alert('Login successful!');
                checkLoginStatus();
            } else {
                alert('Error: ' + result.errors[0].message);
            }
        }

        // Função de login no formulário
        document.getElementById('loginForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            await login(username, password);
        });

        // Função para criar uma nova conta
        async function createAccount(username, password) {
            const query = `
                mutation CreateUser($username: String!, $password: String!) {
                    createUser(username: $username, password: $password) {
                        id
                        username
                    }
                }
            `;
            const variables = { username, password };
            
            const response = await fetch('http://localhost:4000/graphql', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ query, variables })
            });

            const result = await response.json();
            if (result.data && result.data.createUser) {
                alert('Account created successfully!');
            } else {
                alert('Error creating account: ' + result.errors[0].message);
            }
        }

        // Redirecionamento para criar conta
        document.getElementById('createAccountLink').addEventListener('click', function() {
            const username = prompt('Enter your username:');
            const password = prompt('Enter your password:');
            if (username && password) {
                createAccount(username, password);
            }
        });

        // Verifica se o usuário está logado
        function checkLoginStatus() {
            const token = localStorage.getItem('authToken');
            const userID = localStorage.getItem('userID');
            if (token && userID) {
                document.getElementById('showInfoBtn').disabled = false;
                document.getElementById('extraInfo').style.display = 'block';  // Exibe os campos
            }
        }

        // Mostra a seção extra ao clicar no botão
        document.getElementById('showInfoBtn').addEventListener('click', function() {
    const extraInfo = document.getElementById('extraInfo');
    // Verifica se o bloco está visível
    if (extraInfo.style.display === 'block') {
        extraInfo.style.display = 'none';  // Esconde o bloco
    } else {
        extraInfo.style.display = 'block';  // Exibe o bloco
        fetchData();  // Carregar dados se disponíveis
    }
});
        document.getElementById('showCheckupFormBtn').addEventListener('click', function() {
                    const checkupBlock = document.getElementById('checkupBlock');
                    if (checkupBlock.style.display === 'block') {
                        checkupBlock.style.display = 'none';  // Esconde o bloco
                    } else {
                        checkupBlock.style.display = 'block';  // Exibe o bloco
                    }
                });

                async function submitData() {
            const userID = localStorage.getItem('userID');
            const ultimaMenstruacao = document.getElementById('ultimaMenstruacao').value;
            const dataFormatada = new Date(ultimaMenstruacao);
            const isoData = dataFormatada.toISOString();  // Converte para ISO no formato UTC

            const query = `
                mutation CreateGestacao($usuarioId: ID!, $ultimaMenstruacao: String!) {
                    createGestacao(usuarioId: $usuarioId, ultimaMenstruacao: $ultimaMenstruacao) {
                        id
                        ultimaMenstruacao
                    }
                }
            `;

            const variables = { usuarioId: userID, ultimaMenstruacao: isoData };

            await fetch('http://localhost:4000/graphql', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ query, variables })
            }); 
        // Após o envio, buscar a data prevista
            fetchData();
        }

        // Função para buscar dados de gestação
        async function fetchData() {
            const userID = localStorage.getItem('userID');

            const query = `
                query GetGestacao($usuarioId: ID!) {
                    gestacaoPorUsuario(usuarioId: $usuarioId) {
                        id
                        ultimaMenstruacao
                        dataTerminoPrevisto
                    }
                }
            `;

            const variables = { usuarioId: userID };

            const response = await fetch('http://localhost:4000/graphql', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ query, variables })
            });

            const result = await response.json();
            if (result.data && result.data.gestacaoPorUsuario) {
                const dataTermino = result.data.gestacaoPorUsuario.dataTerminoPrevisto;
                if (!isNaN(dataTermino)) {
                    const data = new Date(parseInt(dataTermino));
                    const dia = String(data.getDate()).padStart(2, '0');
                    const mes = String(data.getMonth() + 1).padStart(2, '0');
                    const ano = data.getFullYear();
                    const formattedDate = `${dia}-${mes}-${ano}`;
                    document.getElementById('dataTerminoPrevisto').innerText = formattedDate;
                } else {
                    console.error('Data inválida:', dataTermino);
                    document.getElementById('dataTerminoPrevisto').innerText = "Data inválida.";
                }
            } else {
                console.error("Erro ao buscar dados de gestação:", result.errors);
                document.getElementById('dataTerminoPrevisto').innerText = "Erro ao carregar os dados.";
            }
        }

        document.getElementById('submitDataBtn').addEventListener('click', submitData)

        document.getElementById('submitCheckupBtn').addEventListener('click', async function() {
            const userID = localStorage.getItem('userID');
            const semana = parseInt(document.getElementById('semana').value)
            const peso = parseFloat(document.getElementById('peso').value)
            const comprimento = parseFloat(document.getElementById('comprimento').value)
            const dataRegistro = new Date().toISOString();  // Captura a data e hora atuais
            // Verificação dos valores dos inputs
            if (!semana || !peso || !comprimento) {
                console.error("Missing input values.");
                alert("Preencha todos os valores.");
                return;
            }
            const semanaData = dados.find(item => item.semana === semana);

            if (semanaData) {
                // Preencher valores médios com dados da semana selecionada
                document.getElementById('semanaAvg').value = semanaData.semana;
                document.getElementById('pesoAvg').value = semanaData.peso;
                document.getElementById('comprimentoAvg').value = semanaData.comprimento;
                document.getElementById('randomFact').innerHTML = semanaData.facto;
            } else {
                alert("Semana não encontrada.");
            }
            const query = `
                mutation CreateGravidez($usuarioId: ID!, $semana: Int!, $peso: Float!, $comprimento: Float!, $dataRegistro: String!) {
                    createGravidez(usuarioId: $usuarioId, semana: $semana, peso: $peso, comprimento: $comprimento, dataRegistro: $dataRegistro) {
                        id
                        semana
                        peso
                        comprimento
                        dataRegistro
                    }
                }
            `;
            
            const variables = { usuarioId: userID, semana, peso, comprimento, dataRegistro };
            try {
                const response = await fetch('http://localhost:4000/graphql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query, variables })
                });

                // Log para ver a resposta da API
                const result = await response.json();
            } catch (error) {
                console.error("Error during the request:", error);
                alert("An error occurred during the request.");
            }
        });


        document.getElementById('showResultsBtn').addEventListener('click', function() {
    const resultsTableContainer = document.getElementById('resultsTableContainer');
    const resultsTableBody = document.getElementById('resultsTable').getElementsByTagName('tbody')[0];
    
    // Limpa a tabela antes de adicionar novos dados
    resultsTableBody.innerHTML = '';

    const userID = localStorage.getItem('userID');
    
    // Buscar dados de gravidez para o usuário
    const query = `
        query ($usuarioId: ID!) {
            dadosGravidezPorUsuario(usuarioId: $usuarioId) {
                semana
                peso
                comprimento
            }
        }
    `;
    const variables = { usuarioId: userID };
    
    fetch('http://localhost:4000/graphql', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ query, variables })
    })
    .then(response => response.json())
    .then(data => {   
        if (data.data && data.data.dadosGravidezPorUsuario) {
            // Ordena os dados pelas semanas
            data.data.dadosGravidezPorUsuario.sort((a, b) => a.semana - b.semana);

            // Preencher a tabela com os resultados
            data.data.dadosGravidezPorUsuario.forEach(item => {         
                const semanaData = dados.find(d => d.semana === item.semana);
                if (semanaData) {
                    // Adicionar uma linha na tabela
                    const row = resultsTableBody.insertRow();
                    
                    row.insertCell(0).innerText = item.semana;
                    row.insertCell(1).innerText = item.peso;
                    row.insertCell(2).innerText = item.comprimento;
                    row.insertCell(3).innerText = semanaData.peso;
                    row.insertCell(4).innerText = semanaData.comprimento;
                    row.insertCell(5).innerText = semanaData.facto;
                } else {
                    console.log('Sem dados para semana:', item.semana);  // Verifica se a semanaData não foi encontrada
                }
            });
        } else {
            console.log('Nenhum dado de gravidez encontrado no response');
            alert("Nenhum dado de gravidez encontrado.");
        }
    })
    .catch(error => {
        console.error("Erro ao carregar os resultados:", error);
        alert("Ocorreu um erro ao carregar os resultados.");
    });
});


        // Verifica login ao carregar a página
        checkLoginStatus();
    </script>
</body>
</html>
