<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pregnancy Tracker - Login</title>
</head>
<body>
    <div style="max-width: 400px; margin: 0 auto; padding: 20px;">
        <h1>Welcome to Pregnancy Tracker</h1>
        <p>Login to continue or create an account if you're new.</p>
        
        <!-- Formulário de login -->
        <form id="loginForm" method="POST">
            <label for="username">Username:</label><br>
            <input type="text" id="username" name="username" required><br><br>
            
            <label for="password">Password:</label><br>
            <input type="password" id="password" name="password" required><br><br>
            
            <button type="submit">Login</button>
        </form>
        
        <p>Don't have an account? <a href="#" id="createAccountLink">Create one here</a>.</p>

        <!-- Botão para mostrar informações -->
        <button id="showInfoBtn" disabled>Show More Info</button>

        <!-- Seção escondida inicialmente -->
        <div id="extraInfo" style="display: none;">
            <label for="ultimaMenstruacao">Última Menstruação:</label>
            <input type="date" id="ultimaMenstruacao"><br><br>

            <label>Data Término Previsto:</label>
            <p id="dataTerminoPrevisto"></p>

            <button id="submitDataBtn">Submit</button>
    </div>

    <script>
        // Função para logar e armazenar token e userID
        async function login(username, password) {
            const query = `
                mutation Login($username: String!, $password: String!) {
                    login(username: $username, password: $password) {
                        token
                        user {
                            id
                        }
                    }
                }
            `;
            const variables = { username, password };
            
            const response = await fetch('http://localhost:4000/graphql', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ query, variables })
            });

            const result = await response.json();
            if (result.data && result.data.login) {
                localStorage.setItem('authToken', result.data.login.token);
                localStorage.setItem('userID', result.data.login.user.id);  // Salva o userID no localStorage
                alert('Login successful!');
                checkLoginStatus();
            } else {
                alert('Error: ' + result.errors[0].message);
            }
        }

        // Função de login no formulário
        document.getElementById('loginForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            await login(username, password);
        });

        // Função para criar uma nova conta
        async function createAccount(username, password) {
            const query = `
                mutation CreateUser($username: String!, $password: String!) {
                    createUser(username: $username, password: $password) {
                        id
                        username
                    }
                }
            `;
            const variables = { username, password };
            
            const response = await fetch('http://localhost:4000/graphql', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ query, variables })
            });

            const result = await response.json();
            if (result.data && result.data.createUser) {
                alert('Account created successfully!');
            } else {
                alert('Error creating account: ' + result.errors[0].message);
            }
        }

        // Redirecionamento para criar conta
        document.getElementById('createAccountLink').addEventListener('click', function() {
            const username = prompt('Enter your username:');
            const password = prompt('Enter your password:');
            if (username && password) {
                createAccount(username, password);
            }
        });

        // Verifica se o usuário está logado
        function checkLoginStatus() {
            const token = localStorage.getItem('authToken');
            const userID = localStorage.getItem('userID');
            if (token && userID) {
                document.getElementById('showInfoBtn').disabled = false;
                document.getElementById('extraInfo').style.display = 'block';  // Exibe os campos
            }
        }

        // Mostra a seção extra ao clicar no botão
        document.getElementById('showInfoBtn').addEventListener('click', function() {
    const extraInfo = document.getElementById('extraInfo');
    // Verifica se o bloco está visível
    if (extraInfo.style.display === 'block') {
        extraInfo.style.display = 'none';  // Esconde o bloco
    } else {
        extraInfo.style.display = 'block';  // Exibe o bloco
        fetchData();  // Carregar dados se disponíveis
    }
});

        async function submitData() {
    const userID = localStorage.getItem('userID');
    const ultimaMenstruacao = document.getElementById('ultimaMenstruacao').value;
    const dataFormatada = new Date(ultimaMenstruacao);
    const isoData = dataFormatada.toISOString();  // Converte para ISO no formato UTC

    const query = `
        mutation CreateGestacao($usuarioId: ID!, $ultimaMenstruacao: String!) {
            createGestacao(usuarioId: $usuarioId, ultimaMenstruacao: $ultimaMenstruacao) {
                id
                ultimaMenstruacao
            }
        }
    `;

    const variables = { usuarioId: userID, ultimaMenstruacao: isoData };

    await fetch('http://localhost:4000/graphql', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ query, variables })
    });

    // Após o envio, buscar a data prevista
    fetchData();
}


        // Função para buscar dados de gestação
        async function fetchData() {
            const userID = localStorage.getItem('userID');

            const query = `
                query GetGestacao($usuarioId: ID!) {
                    gestacaoPorUsuario(usuarioId: $usuarioId) {
                        id
                        ultimaMenstruacao
                        dataTerminoPrevisto
                    }
                }
            `;

            const variables = { usuarioId: userID };

            const response = await fetch('http://localhost:4000/graphql', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ query, variables })
            });

            const result = await response.json();
            if (result.data && result.data.gestacaoPorUsuario) {
                const dataTermino = result.data.gestacaoPorUsuario.dataTerminoPrevisto;
                if (!isNaN(dataTermino)) {
                    const data = new Date(parseInt(dataTermino));
                    const dia = String(data.getDate()).padStart(2, '0');
                    const mes = String(data.getMonth() + 1).padStart(2, '0');
                    const ano = data.getFullYear();
                    const formattedDate = `${dia}-${mes}-${ano}`;
                    document.getElementById('dataTerminoPrevisto').innerText = formattedDate;
                } else {
                    console.error('Data inválida:', dataTermino);
                    document.getElementById('dataTerminoPrevisto').innerText = "Data inválida.";
                }
            } else {
                console.error("Erro ao buscar dados de gestação:", result.errors);
                document.getElementById('dataTerminoPrevisto').innerText = "Erro ao carregar os dados.";
            }
        }

        document.getElementById('submitDataBtn').addEventListener('click', submitData)

        // Verifica login ao carregar a página
        checkLoginStatus();
    </script>
</body>
</html>
